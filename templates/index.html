<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Clasificador de Sustancias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: white;
            padding: 20px;
        }

        h1 {
            margin-bottom: 5px;
        }

        .buscador {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
        }

        button, .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            background-color: #00bfff;
            color: white;
            cursor: pointer;
            text-decoration: none;
            white-space: nowrap;
        }

        .acciones {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #1a1a1a;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #333;
            text-align: left;
        }

        th {
            background: #222;
        }

        .editar {
            background: orange;
        }

        .eliminar {
            background: red;
        }

        video {
            margin-top: 20px;
            width: 100%;
            max-width: 350px;
            display: none;
            border-radius: 15px;
        }

        canvas {
            display: none;
        }

        .mensaje {
            margin-top: 10px;
            color: #00ffcc;
        }

    </style>
</head>
<body>

<h1>üß™ Clasificador de Sustancias</h1>
<p>Administr√° y control√° sustancias qu√≠micas registradas en el sistema.</p>

{% with mensajes = get_flashed_messages() %}
  {% if mensajes %}
    <div class="mensaje">
      {% for msg in mensajes %}
        <p>{{ msg }}</p>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<form class="buscador" method="get" action="/">
    <input type="text" name="busqueda" placeholder="Buscar por nombre, peligros, cantidad o ubicaci√≥n..."
           value="{{ busqueda }}">
    <button type="submit">üîç Buscar</button>
</form>

<div class="acciones">
    <a class="btn" href="/agregar">‚ûï Agregar Sustancia</a>
    <a class="btn" href="/exportar_excel">üìÑ Exportar a Excel</a>
    <button onclick="activarCamara()">üì∏ Usar c√°mara</button>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<table>
    <tr>
        <th>N√∫mero</th>
        <th>Nombre</th>
        <th>Peligros</th>
        <th>Cancer√≠geno</th>
        <th>Cantidad</th>
        <th>Ubicaci√≥n</th>
        <th>Acciones</th>
    </tr>

    {% for d in drogas %}
    <tr>
        <td>{{ d.numero }}</td>
        <td>{{ d.nombre }}</td>
        <td>{{ d.peligros }}</td>
        <td>{{ d.cancerigeno }}</td>
        <td>{{ d.cantidad }}</td>
        <td>{{ d.ubicacion }}</td>
        <td>
            <a href="/editar/{{ d.id }}" class="btn editar">‚úèÔ∏è</a>
            <a href="/eliminar/{{ d.id }}" class="btn eliminar"
               onclick="return confirm('¬øEst√°s segura/o de eliminar esta sustancia?')">üóëÔ∏è</a>
        </td>
    </tr>
    {% else %}
    <tr>
        <td colspan="7">No hay sustancias registradas.</td>
    </tr>
    {% endfor %}
</table>

<form id="formCamara" method="POST" action="/detectar_texto" enctype="multipart/form-data">
    <input type="file" name="image" id="imagenInput" style="display: none;">
</form>

<script>
const video = document.getElementById("video");
	let streamGlobal = null;

function activarCamara() {
    video.style.display = "block";

    navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" } },
        audio: false
    })
    .then(stream => {
        streamGlobal = stream;
        video.srcObject = stream;
    })
    .catch(err => {
        navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
            audio: false
        }).then(stream => {
            streamGlobal = stream;
            video.srcObject = stream;
        });
    });
}

// Sacar foto al tocar el video
video.addEventListener("click", () => {

    const canvas = document.getElementById("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    canvas.toBlob(blob => {
        const file = new File([blob], "captura.png", { type: "image/png" });
        const input = document.getElementById("imagenInput");

        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);

        input.files = dataTransfer.files;

        document.getElementById("formCamara").submit();
    });

    if (streamGlobal) {
        streamGlobal.getTracks().forEach(track => track.stop());
        video.style.display = "none";
    }

});
</script>

</body>
</html>


